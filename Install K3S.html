<!DOCTYPE html>
<!--[if lt IE 8 ]><html class="no-js ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="no-js ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 8)|!(IE)]><!--><html class="no-js" lang="en"> <!--<![endif]-->
<head>

   <!--- Basic Page Needs
   ================================================== -->
   <meta charset="utf-8">
	<title>Michael Spanos - Blog</title>
	<meta name="description" content="">
	<meta name="author" content="">

   <!-- Mobile Specific Metas
   ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
    ================================================== -->
   <link rel="stylesheet" href="css/default.css">
	<link rel="stylesheet" href="css/layout.css">
   <link rel="stylesheet" href="css/media-queries.css">
   <link rel="stylesheet" href="css/magnific-popup.css">

   <!-- Script
   ================================================== -->
	<script src="js/modernizr.js"></script>

   <!-- Favicons
	================================================== -->
	<link rel="shortcut icon" href="favicon.png" >

</head>

<body>

   <!-- articles
   ================================================== -->
   <section id="articles">

      <nav id="nav-wrap">

         <a class="mobile-btn" href="#nav-wrap" title="Show navigation">Show navigation</a>
	      <a class="mobile-btn" href="#" title="Hide navigation">Hide navigation</a>

         <ul id="nav" class="nav">
            <li class="current"><a  href="index.html">Home</a></li>
            <li><a class="smoothscroll" href="#about">About</a></li>
	         <li><a class="smoothscroll" href="#resume">Resume</a></li>
            <li><a  href="blog.html">Blog</a></li>
            <li><a href="Blog1.html">Contact</a></li>
         </ul> <!-- end #nav -->

      </nav> <!-- end #nav-wrap -->




<h1>(K3S) Install and configure a Kubernetes cluster with k3s to self-host applications</h1>
<p style="margin: 0; color: grey;"><i class="fa fa-user text-gray"></i>&nbsp;&nbsp;Michalis Spanos&nbsp;</p>
<p style=" color: grey;"><i class="fa fa-calendar text-gray"></i>&nbsp;&nbsp;20 September 2021</p>

<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3>
<img class="size-1" src="images/k3s.png" >
<p>In the previous article, we freshly prepared three machines (one master and two workers). In this article, we are going to learn how to install Kubernetes using <a target="_blank" rel="noopener" href="https://k3s.io/">k3s</a>, a lightweight version of Kubernetes, suitable for ARM-based computers such as Raspberry Pi. If you need any support with k3s, I recommend checking the <a target="_blank" rel="noopener" href="https://rancher.com/docs/k3s/latest/en/">official documentation</a> as well as the <a target="_blank" rel="noopener" href="https://github.com/rancher/k3s">GitHub repository</a>.</p>
<p>Once the cluster is up and each node connected to each other, we will install some useful services such as:</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://helm.sh/">Helm</a>:</strong> Package manager for Kubernetes</li>
<li><strong><a target="_blank" rel="noopener" href="https://metallb.universe.tf/">MetalLB</a>:</strong> Load-balancer implementation for bare metal Kubernetes clusters</li>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx">Nginx</a>:</strong> Kubernetes Ingress Proxy</li>
<li><strong><a target="_blank" rel="noopener" href="https://cert-manager.io/">Cert Manager</a>:</strong> Native Kubernetes certificate management controller.</li>
<li><strong><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">Kubernetes Dashboard</a>:</strong> A web-based Kubernetes user interface</li>
</ul>
<h3 id="Install-k3s-server-master-node"><a href="#Install-k3s-server-master-node" class="headerlink" title="Install k3s server (master node)"></a>Install k3s server (master node)</h3><p>In the first part of this article, we will install the Kubernetes master node which represents the orchestrator of the cluster.</p>
<p><strong>1. Connect via ssh to the master node</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh pi@192.168.0.22</span><br></pre></td></tr></table></figure>


<p><strong>2. Configure the following environment variables</strong></p>
<p>The first line specifies in which mode we would like to write the k3s configuration (required when not running commands as <code>root</code>) and the second line actually says k3s not to deploy its default load balancer named <em>servicelb</em> and proxy <em>traefik</em>, instead we will install manually <a target="_blank" rel="noopener" href="https://metallb.universe.tf/"><em>metalb</em></a> as load balancer and <a target="_blank" rel="noopener" href="https://www.nginx.com/"><em>nginx</em></a> as proxy which are in my opinion better and more widely used.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ export K3S_KUBECONFIG_MODE&#x3D;&quot;644&quot;</span><br><span class="line">$ export INSTALL_K3S_EXEC&#x3D;&quot; --no-deploy servicelb --no-deploy traefik&quot;</span><br></pre></td></tr></table></figure>


<p><strong>3. Run the installer</strong></p>
<p>The next command simply downloads and executes the k3s installer. The installation will take into account the environment variables set just before.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sfL https:&#x2F;&#x2F;get.k3s.io | sh -</span><br><span class="line"></span><br><span class="line">[INFO]  Finding latest release</span><br><span class="line">[INFO]  Using v1.17.0+k3s.1 as release</span><br><span class="line">[INFO]  Downloading hash https:&#x2F;&#x2F;github.com&#x2F;rancher&#x2F;k3s&#x2F;releases&#x2F;download&#x2F;v1.17.0+k3s.1&#x2F;sha256sum-arm.txt</span><br><span class="line">[INFO]  Downloading binary https:&#x2F;&#x2F;github.com&#x2F;rancher&#x2F;k3s&#x2F;releases&#x2F;download&#x2F;v1.17.0+k3s.1&#x2F;k3s-armhf</span><br><span class="line">[INFO]  Verifying binary download</span><br><span class="line">[INFO]  Installing k3s to &#x2F;usr&#x2F;local&#x2F;bin&#x2F;k3s</span><br><span class="line">[INFO]  Creating &#x2F;usr&#x2F;local&#x2F;bin&#x2F;kubectl symlink to k3s</span><br><span class="line">[INFO]  Creating &#x2F;usr&#x2F;local&#x2F;bin&#x2F;crictl symlink to k3s</span><br><span class="line">[INFO]  Creating &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ctr symlink to k3s</span><br><span class="line">[INFO]  Creating killall script &#x2F;usr&#x2F;local&#x2F;bin&#x2F;k3s-killall.sh</span><br><span class="line">[INFO]  Creating uninstall script &#x2F;usr&#x2F;local&#x2F;bin&#x2F;k3s-uninstall.sh</span><br><span class="line">[INFO]  env: Creating environment file &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;k3s.service.env</span><br><span class="line">[INFO]  systemd: Creating service file &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;k3s.service</span><br><span class="line">[INFO]  systemd: Enabling k3s unit</span><br><span class="line">Created symlink &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;multi-user.target.wants&#x2F;k3s.service → &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;k3s.service.</span><br><span class="line">[INFO]  systemd: Starting k3s</span><br></pre></td></tr></table></figure>


<p><strong>4. Verify the status</strong></p>
<p>The installer creates a systemd service which can be used for <code>stop</code>, <code>start</code>, <code>restart</code> and verify the <code>status</code> of the k3s server running Kubernetes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl status k3s</span><br><span class="line"></span><br><span class="line">● k3s.service - Lightweight Kubernetes</span><br><span class="line">   Loaded: loaded (&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;k3s.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Fri 2020-01-10 19:26:41 GMT; 9s ago</span><br><span class="line">     Docs: https:&#x2F;&#x2F;k3s.io</span><br><span class="line">  Process: 900 ExecStartPre&#x3D;&#x2F;sbin&#x2F;modprobe br_netfilter (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)</span><br><span class="line">  Process: 902 ExecStartPre&#x3D;&#x2F;sbin&#x2F;modprobe overlay (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)</span><br><span class="line"> Main PID: 904 (k3s-server)</span><br><span class="line">    Tasks: 14</span><br><span class="line">   Memory: 395.0M</span><br><span class="line">(...)</span><br></pre></td></tr></table></figure>

<p>k3s also installed the <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/overview/">Kubernetes Command Line Tools</a> <code>kubectl</code>, so it is possible to start querying the cluster (composed at this stage, of only one node - the master, and a few internal services used by Kubernetes).</p>
<ul>
<li>To get the details of the nodes</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes -o wide</span><br><span class="line"></span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION         INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION   CONTAINER-RUNTIME</span><br><span class="line">kube-master   Ready    master   29m   v1.17.0+k3s.1   192.168.0.22   &lt;none&gt;        Raspbian GNU&#x2F;Linux 10 (buster)   4.19.75-v7l+     containerd:&#x2F;&#x2F;1.3.0-k3s.5</span><br></pre></td></tr></table></figure>

<ul>
<li>To get the details of all the services deployed</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -A -o wide</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE   IP          NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   metrics-server-6d684c7b5-w2qdj            1&#x2F;1     Running   0          30m   10.42.0.3   kube-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   local-path-provisioner-58fb86bdfd-jmdjh   1&#x2F;1     Running   0          30m   10.42.0.4   kube-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-d798c9dd-vh56g                    1&#x2F;1     Running   0          30m   10.42.0.2   kube-master   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>


<p><strong>5. Save the access token</strong></p>
<p>Each agent will require an access token to connect to the server, the token can be retrieved with the following commands:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cat &#x2F;var&#x2F;lib&#x2F;rancher&#x2F;k3s&#x2F;server&#x2F;node-token</span><br><span class="line"></span><br><span class="line">K106edce2ad174510a840ff7e49680fc556f8830173773a1ec1a5dc779a83d4e35b::server:5a9b70a1f5bc02a7cf775f97fa912345</span><br></pre></td></tr></table></figure>



<h3 id="Install-k3s-agent-worker-nodes"><a href="#Install-k3s-agent-worker-nodes" class="headerlink" title="Install k3s agent (worker nodes)"></a>Install k3s agent (worker nodes)</h3><p>In the second part, we are now installing the k3s agent to connect on each worker to the k3s server (master).</p>
<p><strong>1. Connect via ssh to the worker node</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh pi@192.168.0.23</span><br></pre></td></tr></table></figure>


<p><strong>2. Configure the following environment variables</strong></p>
<p>The first line specifies in which mode we would like to write the k3s configuration (required when not running command as <code>root</code>) and the second line provide the k3s server endpoint the agent needs to connect to. Finally, the third line is an access token to the k3s server saved previously.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ export K3S_KUBECONFIG_MODE&#x3D;&quot;644&quot;</span><br><span class="line">$ export K3S_URL&#x3D;&quot;https:&#x2F;&#x2F;192.168.0.22:6443&quot;</span><br><span class="line">$ export K3S_TOKEN&#x3D;&quot;K106edce2ad174510a840ff7e49680fc556f8830173773a1ec1a5dc779a83d4e35b::server:5a9b70a1f5bc02a7cf775f97fa912345&quot;</span><br></pre></td></tr></table></figure>


<p><strong>3. Run the installer</strong></p>
<p>The next command simply downloads and executes the k3s installer. The installation will take into account the environment variables set just before and install the agent.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sfL https:&#x2F;&#x2F;get.k3s.io | sh -</span><br><span class="line"></span><br><span class="line">[INFO]  Finding latest release</span><br><span class="line">[INFO]  Using v1.17.0+k3s.1 as release</span><br><span class="line">[INFO]  Downloading hash https:&#x2F;&#x2F;github.com&#x2F;rancher&#x2F;k3s&#x2F;releases&#x2F;download&#x2F;v1.17.0+k3s.1&#x2F;sha256sum-arm64.txt</span><br><span class="line">[INFO]  Downloading binary https:&#x2F;&#x2F;github.com&#x2F;rancher&#x2F;k3s&#x2F;releases&#x2F;download&#x2F;v1.17.0+k3s.1&#x2F;k3s-arm64</span><br><span class="line">[INFO]  Verifying binary download</span><br><span class="line">[INFO]  Installing k3s to &#x2F;usr&#x2F;local&#x2F;bin&#x2F;k3s</span><br><span class="line">[INFO]  Creating &#x2F;usr&#x2F;local&#x2F;bin&#x2F;kubectl symlink to k3s</span><br><span class="line">[INFO]  Creating &#x2F;usr&#x2F;local&#x2F;bin&#x2F;crictl symlink to k3s</span><br><span class="line">[INFO]  Creating &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ctr symlink to k3s</span><br><span class="line">[INFO]  Creating killall script &#x2F;usr&#x2F;local&#x2F;bin&#x2F;k3s-killall.sh</span><br><span class="line">[INFO]  Creating uninstall script &#x2F;usr&#x2F;local&#x2F;bin&#x2F;k3s-agent-uninstall.sh</span><br><span class="line">[INFO]  env: Creating environment file &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;k3s-agent.service.env</span><br><span class="line">[INFO]  systemd: Creating service file &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;k3s-agent.service</span><br><span class="line">[INFO]  systemd: Enabling k3s-agent unit</span><br><span class="line">Created symlink &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;multi-user.target.wants&#x2F;k3s-agent.service → &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;k3s-agent.service.</span><br><span class="line">[INFO]  systemd: Starting k3s-agent</span><br></pre></td></tr></table></figure>


<p><strong>4. Verify the status</strong></p>
<p>The installer creates a systemd service which can be used for <code>stop</code>, <code>start</code>, <code>restart</code> and verify the <code>status</code> of the k3s agent running Kubernetes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl status k3s-agent</span><br><span class="line"></span><br><span class="line">● k3s-agent.service - Lightweight Kubernetes</span><br><span class="line">   Loaded: loaded (&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;k3s-agent.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Sun 2020-01-12 16:03:07 UTC; 9s ago</span><br><span class="line">     Docs: https:&#x2F;&#x2F;k3s.io</span><br><span class="line">  Process: 4970 ExecStartPre&#x3D;&#x2F;sbin&#x2F;modprobe br_netfilter (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)</span><br><span class="line">  Process: 4973 ExecStartPre&#x3D;&#x2F;sbin&#x2F;modprobe overlay (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)</span><br><span class="line"> Main PID: 4974 (k3s-agent)</span><br><span class="line">    Tasks: 16</span><br><span class="line">   Memory: 205.1M</span><br><span class="line">(...)</span><br></pre></td></tr></table></figure>

<p>k3s also installed the <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/overview/">Kubernetes Command Line Tools</a> <code>kubectl</code>, so it is possible to start querying the cluster and observe the all nodes are reconciliated.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes -o wide</span><br><span class="line"></span><br><span class="line">NAME           STATUS   ROLES    AGE     VERSION         INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class="line">kube-master    Ready    master   44h     v1.17.0+k3s.1   192.168.0.22   &lt;none&gt;        Raspbian GNU&#x2F;Linux 10 (buster)   4.19.75-v7l+       containerd:&#x2F;&#x2F;1.3.0-k3s.5</span><br><span class="line">kube-worker1   Ready    &lt;none&gt;   2m47s   v1.17.0+k3s.1   192.168.0.23   &lt;none&gt;        Debian GNU&#x2F;Linux 10 (buster)     5.4.6-rockchip64   containerd:&#x2F;&#x2F;1.3.0-k3s.5</span><br><span class="line">kube-worker2   Ready    &lt;none&gt;   2m9s    v1.17.0+k3s.1   192.168.0.24   &lt;none&gt;        Raspbian GNU&#x2F;Linux 10 (buster)   4.19.75-v7+        containerd:&#x2F;&#x2F;1.3.0-k3s.5</span><br></pre></td></tr></table></figure>




<h3 id="Connect-remotely-to-the-cluster"><a href="#Connect-remotely-to-the-cluster" class="headerlink" title="Connect remotely to the cluster"></a>Connect remotely to the cluster</h3><p>If you don’t want to connect via SSH to a node every time you need to query your cluster, it is possible to install <code>kubectl</code> (k8s command line tool) on your local machine and control remotely your cluster.</p>
<p><strong>1. Install kubectl on your local machine</strong></p>
<p>Read the <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">following page</a> to know how to install <code>kubectl</code> on Linux, MacOS or Windows.</p>
<p><strong>2. Copy the k3s config file from the master node to your local machine</strong></p>
<p>The command <code>scp</code> allows to transfer file via SSH from/to a remote machine. We simply need to download the file <code>/etc/rancher/k3s/k3s.yaml</code> located on the master node to our local machine into <code>~/.kube/config</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ scp pi@192.168.0.22:&#x2F;etc&#x2F;rancher&#x2F;k3s&#x2F;k3s.yaml ~&#x2F;.kube&#x2F;config</span><br></pre></td></tr></table></figure>

<p>The file contains a localhost endpoint <code>127.0.0.1</code>, we just need to replace this by the IP address of the master node instead (in my case <code>192.168.0.22</code>).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i &#39;&#39; &#39;s&#x2F;127\.0\.0\.1&#x2F;192\.168\.0\.22&#x2F;g&#39; ~&#x2F;.kube&#x2F;config</span><br></pre></td></tr></table></figure>


<p><strong>3. Try using <code>kubectl</code> from your local machine</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes -o wide</span><br><span class="line"></span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION         INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class="line">kube-worker1   Ready    &lt;none&gt;   18m   v1.17.0+k3s.1   192.168.0.23   &lt;none&gt;        Debian GNU&#x2F;Linux 10 (buster)     5.4.6-rockchip64   containerd:&#x2F;&#x2F;1.3.0-k3s.5</span><br><span class="line">kube-worker2   Ready    &lt;none&gt;   17m   v1.17.0+k3s.1   192.168.0.24   &lt;none&gt;        Raspbian GNU&#x2F;Linux 10 (buster)   4.19.75-v7+        containerd:&#x2F;&#x2F;1.3.0-k3s.5</span><br><span class="line">kube-master    Ready    master   44h   v1.17.0+k3s.1   192.168.0.22   &lt;none&gt;        Raspbian GNU&#x2F;Linux 10 (buster)   4.19.75-v7l+       containerd:&#x2F;&#x2F;1.3.0-k3s.5</span><br></pre></td></tr></table></figure>





<h3 id="Install-Helm-version-gt-3-x-y-Kubernetes-Package-Manager"><a href="#Install-Helm-version-gt-3-x-y-Kubernetes-Package-Manager" class="headerlink" title="Install Helm (version &gt;= 3.x.y) - Kubernetes Package Manager"></a>Install Helm (version &gt;= 3.x.y) - Kubernetes Package Manager</h3><p><a target="_blank" rel="noopener" href="https://helm.sh/">Helm</a> is a package manager for Kubernetes. An application deployed on Kubernetes is usually composed of multiple config files (deployment, service, secret, ingress, etc.) which can be more or less complex and are generally the same for common applications.</p>
<p>Helm provides a solution to define, install, upgrade k8s applications based on config templates (called <em>charts</em>). A simple unique config file (names Values.yml) is used to generate all the necessary k8s config files and deploy them. The repository <a target="_blank" rel="noopener" href="https://hub.helm.sh/">hub.helm.sh</a> contains all the “official” charts available but you can easily find unofficial charts online.</p>
<p><strong>1. Install Helm command line tools on your local machine</strong></p>
<p>Refer to the <a target="_blank" rel="noopener" href="https://helm.sh/docs/intro/install">following page</a> to install <code>helm</code> on your local machine. <strong>You must install Helm version &gt;= 3.x.y</strong></p>
<p>Example for Linux:</p>
<ul>
<li>Download the package on <a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">GitHub</a></li>
<li>Run <code>$ tar -zxvf helm-v3.&lt;X&gt;.&lt;Y&gt;-linux-amd64.tar.gz</code> (replace <code>3.&lt;Y&gt;.&lt;Y&gt;</code> by the latest version)</li>
<li>Execute <code>$ mv linux-amd64/helm /usr/local/bin/helm</code></li>
</ul>
<p><strong>2. Check the version</strong></p>
<p>Verify that you have Helm version 3.x installed.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm version</span><br><span class="line">version.BuildInfo&#123;Version:&quot;v3.0.2&quot;, GitCommit:&quot;19e47ee3283ae98139d98460de796c1be1e3975f&quot;, GitTreeState:&quot;clean&quot;, GoVersion:&quot;go1.13.5&quot;&#125;</span><br></pre></td></tr></table></figure>


<p><strong>3. Add the repository for official charts</strong></p>
<p>Configure the repository <code>stable https://kubernetes-charts.storage.googleapis.com</code> to access the <a target="_blank" rel="noopener" href="https://github.com/helm/charts/tree/master/stable">official charts</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add stable https:&#x2F;&#x2F;kubernetes-charts.storage.googleapis.com</span><br><span class="line">&quot;stable&quot; has been added to your repositories</span><br><span class="line"></span><br><span class="line">$ helm repo update</span><br><span class="line">Hang tight while we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the &quot;stable&quot; chart repository</span><br><span class="line">Update Complete. ⎈ Happy Helming!⎈</span><br></pre></td></tr></table></figure>



<p>We can now install application using Helm using <code>helm install &lt;deployment_name&gt; &lt;chart_name&gt; --namespace &lt;namespace&gt; --set &lt;property_value_to_change&gt;</code>, uninstall application running <code>helm uninstall &lt;deployment_name&gt; --namespace &lt;namespace&gt;</code> and list the applications with <code>helm list --namespace &lt;namespace&gt;</code></p>
<p>I also recommend checking this page to learn more <a target="_blank" rel="noopener" href="https://helm.sh/docs/intro/using_helm/">how to use Helm cli</a>.</p>
<h3 id="Install-MetalLB-Kubernetes-Load-Balancer"><a href="#Install-MetalLB-Kubernetes-Load-Balancer" class="headerlink" title="Install MetalLB - Kubernetes Load Balancer"></a>Install MetalLB - Kubernetes Load Balancer</h3><p><a target="_blank" rel="noopener" href="https://metallb.universe.tf/">MetalLB</a> is a load-balancer implementation for bare metal Kubernetes clusters. When configuring a <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes service</a> of type <em>LoadBalancer</em>, MetalLB will dedicate a virtual IP from an address-pool to be used as load balancer for an application.</p>
<p>To install MetalLB from Helm, you simply need to run the following command <code>helm install ...</code> with:</p>
<ul>
<li><code>metallb</code>: the name to give to the deployment</li>
<li><code>stable/metallb</code>: the name of the <a target="_blank" rel="noopener" href="https://github.com/helm/charts/tree/master/stable/metallb">chart</a></li>
<li><code>--namespace kube-system</code>: the namespace in which we want to deploy MetalLB.</li>
<li><code>--set configInline...</code>: to configures MetalLB in <strong>Layer 2</strong> mode (see <a target="_blank" rel="noopener" href="https://metallb.universe.tf/configuration/">documentation</a> for more details). The IPs range <code>192.168.0.240-192.168.0.250</code> is used to constitute a pool of virtual IP addresses.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo add stable https:&#x2F;&#x2F;charts.helm.sh&#x2F;stable</span><br><span class="line">$ helm install metallb stable&#x2F;metallb --namespace kube-system \</span><br><span class="line">  --set configInline.address-pools[0].name&#x3D;default \</span><br><span class="line">  --set configInline.address-pools[0].protocol&#x3D;layer2 \</span><br><span class="line">  --set configInline.address-pools[0].addresses[0]&#x3D;192.168.0.240-192.168.0.250</span><br></pre></td></tr></table></figure>

<p>After a few seconds, you should observe the MetalLB components deployed under <code>kube-system</code> namespace.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system -l app&#x3D;metallb -o wide</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE     IP             NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   metallb-speaker-s7cvp                     1&#x2F;1     Running   0          2m47s   192.168.0.22   kube-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   metallb-speaker-jx64v                     1&#x2F;1     Running   0          2m47s   192.168.0.23   kube-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   metallb-controller-6fb88ff94b-4g256       1&#x2F;1     Running   0          2m47s   10.42.1.7      kube-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   metallb-speaker-k5kbh                     1&#x2F;1     Running   0          2m47s   192.168.0.24   kube-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>All done. No every time a new Kubenertes service of type <em>LoadBalancer</em> is deployed, MetalLB will assign an IP from the pool to access the application.</p>
<h3 id="Install-Nginx-Web-Proxy"><a href="#Install-Nginx-Web-Proxy" class="headerlink" title="Install Nginx - Web Proxy"></a>Install Nginx - Web Proxy</h3><p><a target="_blank" rel="noopener" href="https://www.nginx.com/">Nginx</a> is a recognized high-performance web server / reverse proxy. It can be used as <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Kubernetes Ingress</a> to expose HTTP and HTTPS routes from outside the cluster to services within the cluster.</p>
<p>Similarly to MetalLB, we will use the following <a target="_blank" rel="noopener" href="https://github.com/helm/charts/tree/master/stable/nginx-ingress">stable/nginx-ingress Helm chart</a> to install our proxy server.</p>
<p>The only config change done here is disabling <code>defaultBackend</code> which isn’t required.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm install nginx-ingress stable&#x2F;nginx-ingress --namespace kube-system \</span><br><span class="line">    --set defaultBackend.enabled&#x3D;false</span><br></pre></td></tr></table></figure>


<p>After a few seconds, you should observe the Nginx component deployed under <code>kube-system</code> namespace.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system -l app&#x3D;nginx-ingress -o wide</span><br><span class="line"></span><br><span class="line">NAME                                             READY   STATUS    RESTARTS   AGE     IP          NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ingress-controller-996c5bf9-k4j64   1&#x2F;1     Running   0          76s   10.42.1.13   kube-worker1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>Interestingly, Nginx service is deployed in LoadBalancer mode, you can observe MetalLB allocates a virtual IP (column <code> EXTERNAL-IP</code>) to Nginx with the command here:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get services  -n kube-system -l app&#x3D;nginx-ingress -o wide</span><br><span class="line"></span><br><span class="line">NAME                            TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)                      AGE   SELECTOR</span><br><span class="line">nginx-ingress-controller   LoadBalancer   10.43.253.188   192.168.0.240   80:30423&#x2F;TCP,443:32242&#x2F;TCP   92s   app&#x3D;nginx-ingress,component&#x3D;controller,release&#x3D;nginx-ingress</span><br></pre></td></tr></table></figure>

<p>From you local machine, you can try to externally access Nginx via the LoadBalancer IP (in my case <code>http://192.168.0.240</code>) and it should return the following message “404 not found” because nothing is deployed yet.</p>

<p><strong>1. Install kubernetes-dashboard via the official “recommended” manifests file</strong></p>
<p>Execute the following command and replace <code>&lt;VERSION&gt;</code> by the latest version (see <a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/releases">release page</a>)</p>
<p><em>Tested with version: <strong>v2.0.3</strong></em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;dashboard&#x2F;&lt;VERSION&gt;&#x2F;aio&#x2F;deploy&#x2F;recommended.yaml</span><br></pre></td></tr></table></figure>


<p>After a few seconds, you should see to pods running in the namespace <code>kubernetes-dashboard</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-b68468655-jg6pz   1&#x2F;1     Running   0          26m</span><br><span class="line">kubernetes-dashboard-64999dbccd-79whq       1&#x2F;1     Running   0          26m</span><br></pre></td></tr></table></figure>


<p><strong>2. Create <code>admin-user</code> to connect kubernetes-dashboard</strong></p>
<p>According to the <a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">wiki</a>, create a new user named <code>admin-user</code> to grant this user admin permissions and login to Dashboard using bearer token tied to this user.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<p><strong>3. Retrieve the unique access token of <code>admin-user</code></strong></p>
<p>In order to authenticate to the dashboard web page, we will need to provide a token we can retrieve by executing the command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk &#39;&#123;print $1&#125;&#39;)</span><br><span class="line"></span><br><span class="line">Name:         admin-user-token-tr2dp</span><br><span class="line">Namespace:    kubernetes-dashboard</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io&#x2F;service-account.name: admin-user</span><br><span class="line">              kubernetes.io&#x2F;service-account.uid: 9507154d-0742-4af0-87c9-1fe97143f5fe</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io&#x2F;service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">ca.crt:     526 bytes</span><br><span class="line">namespace:  20 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1Ni...GscCR9APmOxm53jwLj8XFqw [COPY HERE]</span><br></pre></td></tr></table></figure>

<p><em>Copy the token value</em></p>
<p><strong>4. Create a secure channel to access the kubernetes-dashboard</strong></p>
<p>To access kubernetes-dashboard from your local machine, you must create a secure channel to your Kubernetes cluster. Run the following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$  kubectl proxy</span><br><span class="line"></span><br><span class="line">Starting to serve on 127.0.0.1:8001</span><br></pre></td></tr></table></figure>


<p><strong>5. Connect to kubernetes-dashboard</strong></p>
<p>Now we have a secure channel, you can access kubernetes-dashboard via the following URL: <a target="_blank" rel="noopener" href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</a>.</p>
<p>Select “Token”, copy/paste the token previously retrieved and click on “Sign in”.</p>

<p>Well done, you have now access to a nice web interface to visialise and manage all the Objects of your Kubernetes cluster (<em>you can switch namespace with the dropdown on the left menu</em>).</p>

<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>In conclusion of this article, we now have a ready to use Kubernetes cluster to self-host applications. In the next articles, we will learn how to deploy specific applications such as a Media manager with Plex, a self-hosted file sharing solution similar to DropBox and more.</p>
<h3 id="Teardown"><a href="#Teardown" class="headerlink" title="Teardown"></a>Teardown</h3><p>If you want to uninstall completely the Kubernetes from a machine.</p>
<p><strong>1. Worker node</strong></p>
<p>Connect to the worker node and run the following commands:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo &#x2F;usr&#x2F;local&#x2F;bin&#x2F;k3s-agent-uninstall.sh</span><br><span class="line">$ sudo rm -rf &#x2F;var&#x2F;lib&#x2F;rancher</span><br></pre></td></tr></table></figure>


<p><strong>2. Master node</strong></p>
<p>Connect to the master node and run the following commands:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo &#x2F;usr&#x2F;local&#x2F;bin&#x2F;k3s-uninstall.sh</span><br><span class="line">$ sudo rm -rf &#x2F;var&#x2F;lib&#x2F;rancher</span><br></pre></td></tr></table></figure>

</article>
   </section>

 <!-- footer
   ================================================== -->
   <footer>

    <div class="row">

       <div class="twelve columns">

          <ul class="social-links">
             <li><a href="https://www.linkedin.com/in/michalis-spanos/"><i class="fa fa-linkedin"></i></a></li>
             <li><a href="mailto:mspanos@outlook.com"><i class="fa fa-envelope"></i></a></li>
          </ul>

          <ul class="copyright">
             <li>&copy; Copyright 2022 mspanos</li>
             <li>Design by <a href="http://www.styleshout.com/" title="Styleshout" target="_blank">Styleshout</a></li>   
          </ul>

       </div>

       <div id="go-top"><a class="smoothscroll" title="Back to Top" href="#articles"><i class="icon-up-open"></i></a></div>

    </div>

 </footer> <!-- Footer End-->

 <!-- Java Script
 ================================================== -->
 <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
 <script>window.jQuery || document.write('<script src="js/jquery-1.10.2.min.js"><\/script>')</script>
 <script type="text/javascript" src="js/jquery-migrate-1.2.1.min.js"></script>

 <script src="js/jquery.flexslider.js"></script>
 <script src="js/waypoints.js"></script>
 <script src="js/jquery.fittext.js"></script>
 <script src="js/magnific-popup.js"></script>
 <script src="js/init.js"></script>

</body>

</html>